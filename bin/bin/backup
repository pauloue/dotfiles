#!/usr/bin/env bash
#
# Backup home folder to $BACKUP_DIR/$DEST, keeping incremental old backups
# Excludes files that match the exclude patterns in $BACKUP_DIR/exclude
# 'backup restore' restores the most recent backup to the home folder

set -e

BACKUP_DIR="/run/media/paul/Elements/backups"
DEST="backup-$(date +%F)"
RSYNC_OPTS=("-azh" "--del" "--info=progress2,stats")

case $1 in
    "" ) action="backup" ;;
    restore ) action="restore" ;;
    * ) echo "Error: Invalid option '$1'"; exit 1 ;;
esac

if [[ -d $BACKUP_DIR ]]; then cd $BACKUP_DIR
else
    echo "Error: $BACKUP_DIR: No such file or directory"; exit 1
fi

[[ -f last-backup ]] && last_backup="$(< last-backup)"

backup() {
    read -rp "Enter a description for the backup: " desc
    echo "Backing up $HOME to $BACKUP_DIR/$DEST"
    if [[ $last_backup && $last_backup != "$DEST" ]]; then
        mv "$last_backup" "$DEST"
        RSYNC_OPTS+=("-b" "--backup-dir=../$last_backup")
    fi
    [[ -f $BACKUP_DIR/exclude ]] && RSYNC_OPTS+=("--exclude-from=exclude")
    rsync "${RSYNC_OPTS[@]}" "$HOME/" "$DEST"
    [[ "$desc" ]] && echo "$desc" > "$DEST/backup-info"
    echo "$DEST" > last-backup
}

restore() {
    if [[ -d $last_backup ]]; then
        echo "Restoring $BACKUP_DIR/$last_backup to $HOME/$last_backup"
        rsync "${RSYNC_OPTS[@]}" "$last_backup" "$HOME"
    else
        echo "Error: Backup not found"; exit 1
    fi
}

[[ $action == "backup" ]] && backup
[[ $action == "restore" ]] && restore
